   pipeline {
    
    agent any
    
    parameters {
        choice ( name: 'project', choices: ['monitor-service'], description: 'é€‰æ‹©é¡¹ç›®åˆ«å' )
        string ( name: 'BRANCH', defaultValue: 'local', description: 'è¾“å…¥éœ€è¦æ›´æ–°çš„Gitåˆ†æ”¯' )
        choice ( name: 'REGION', choices: ['cn-east','us-east'], description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ' )
    }
    
    environment {
        email_addr="tom@updf.cn"
        harbor="registry.cn-hangzhou.aliyuncs.com"
        GIT_URL="git@gitee.com:superace-updf/updf.com.git"
        cn_host="10.10.10.200" 
        us_host="10.10.10.204"
        project_env="local"
    }

    stages {
        stage('æ¸…é™¤ç©ºé—´') {
            steps {
                // Clean before build
                cleanWs()
            }
        }
        stage('æ‹‰å–ä»£ç ') {
            steps {
                script {
                    println "----------------------------------------åˆ†æ”¯ä¸ºï¼š${BRANCH}-----------------------------------------"
                        try {                        
  
                            checkout(    
                                [$class: 'GitSCM', doGenerateSubmoduleConfigurations: false, submoduleCfg: [], extensions: [[$class: 'CloneOption', depth: 1, noTags: false, reference: '', shallow: true]],
                                branches: [[name: "$BRANCH"]],userRemoteConfigs: [[url: "${env.GIT_URL}", credentialsId: "20230717"]]]
                            
                            )
                        }catch(exc) {   
                            env.REASON = "æ‹‰å–ä»£ç å‡ºé”™"
                            throw(exc)
                            }
                    // å®šä¹‰å…¨å±€å˜é‡
                    env.COMMIT_ID   = sh(script: 'git log --pretty=format:%h',  returnStdout: true).trim() // æäº¤ID
                    env.COMMIT_USER = sh(script: 'git log --pretty=format:%an', returnStdout: true).trim() // æäº¤è€…
                    env.COMMIT_TIME = sh(script: 'git log --pretty=format:%ai', returnStdout: true).trim() // æäº¤æ—¶é—´
                    env.COMMIT_INFO = sh(script: 'git log --pretty=format:%s',  returnStdout: true).trim() // æäº¤ä¿¡æ¯
                    
                    println "------------------------------------------æäº¤IDä¸ºï¼š ${COMMIT_ID}--------------------------------------------------- "
                    println "------------------------------------------æäº¤è€…ä¸ºï¼š ${env.COMMIT_USER} ---------------------------------------------"
                    println "------------------------------------------æäº¤æ—¶é—´ä¸ºï¼š ${env.COMMIT_TIME}-------------------------------------------- "
                    println "------------------------------------------æäº¤ä¿¡æ¯ä¸ºï¼š ${env.COMMIT_INFO} --------------------------------------------"
                }
            }
        }
        stage('Build Go') {
            steps{
                script{
                    println "---------------------------------------------å½“å‰å·¥ä½œç©ºé—´ä¸ºï¼š${WORKSPACE}----------------------------------------------"                   
                    sh ''' 
                        cd ${WORKSPACE}/monitor_service/ && mkdir build 
                        source /etc/profile  >/dev/null 2>&1
                        GOPROXY=https://goproxy.cn;GOPRIVATE=gitee.com/superace-updf
                        go build -o build/${project}  
                        mv config/ views/ build/
                        chmod +x build/${project}
                    '''
               
                }
            }
        }
        stage('Build Image') {
            steps{
                script{

                        sh '''
                        docker build --build-arg UPDF_ENV=${project_env} --build-arg REGION_ARG=${REGION} ${WORKSPACE}/monitor_service/ -t $harbor/updf/${project_env}-$project:${COMMIT_ID}
                        docker push $harbor/updf/${project_env}-$project:${COMMIT_ID}
                        '''
   
                  } 
                println "----------------------------------------ä¸Šä¼ é•œåƒä¸ºï¼š$harbor/updf/${project_env}-$project:${COMMIT_ID}-----------------------------------------"  
            }
        }
        stage('DEL ASK') {
          steps{    
            script{

                if( "$REGION" == 'cn-east' ){
                    sh '''
                    ssh root@$cn_host "sudo echo "Tag=${COMMIT_ID}" > /opt/project/${project}/.env && sudo docker-compose -f /opt/project/${project}/docker-compose.yaml up -d"
                    '''
                }else{
                    sh '''
                    ssh root@$us_host "sudo echo "Tag=${COMMIT_ID}" > /opt/project/${project}/.env && sudo docker-compose -f /opt/project/${project}/docker-compose.yaml up -d"
                    '''
                }
                
            }
          }
        }       

    }
    post {
        success {
            feiShuTalk (
                robot: "feishu-failse",
                type: "INTERACTIVE",
                title: "ğŸ“¢ Jenkins æ„å»ºé€šçŸ¥",
                text: [
                    "ğŸ“‹ **ä»»åŠ¡åç§°**ï¼š[${JOB_NAME}](${JOB_URL})",
                    "ğŸ”¢ **ä»»åŠ¡ç¼–å·**ï¼š[${BUILD_DISPLAY_NAME}](${BUILD_URL})",
                    "ğŸŒŸ **æ„å»ºçŠ¶æ€**: <font color='green'>æˆåŠŸ</font>",
                    "ğŸ• **æ„å»ºç”¨æ—¶**: ${currentBuild.duration} ms",
                    "ğŸ‘¤ **Project Nmae**: ${project}",
                    "<at id=all></at>"
                ],
                buttons: [
                    [
                        title: "æ›´æ”¹è®°å½•",
                        url: "${BUILD_URL}changes"
                    ],
                    [
                        title: "æ§åˆ¶å°",
                        type: "danger",
                        url: "${BUILD_URL}console"
                    ]
                ]
            )
        }
        failure {
            feiShuTalk (
                robot: "feishu-failse",
                type: "INTERACTIVE",
                title: "ğŸ“¢ Jenkins æ„å»ºé€šçŸ¥",
                text: [
                    "ğŸ“‹ **ä»»åŠ¡åç§°**ï¼š[${JOB_NAME}](${JOB_URL})",
                    "ğŸ”¢ **ä»»åŠ¡ç¼–å·**ï¼š[${BUILD_DISPLAY_NAME}](${BUILD_URL})",
                    "ğŸŒŸ **æ„å»ºçŠ¶æ€**: <font color='red'>å¤±è´¥</font>",
                    "ğŸ• **æ„å»ºç”¨æ—¶**: ${currentBuild.duration} ms",
                    "ğŸ‘¤ **Project Nmae**: ${project}",
                    "<at id=all></at>"
                ],
                buttons: [
                   [
                      title: "æ›´æ”¹è®°å½•",
                      url: "${BUILD_URL}changes"
                   ],
                   [
                      title: "æ§åˆ¶å°",
                      type: "danger",
                      url: "${BUILD_URL}console"
                   ]
                ]
              )
        }
    }
 }
